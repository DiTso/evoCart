Noty.overrideDefaults({layout:"topRight",theme:"metroui",timeout:1500});var ec_delivery=document.querySelector(".js-ec-delivery"),ec_city=document.querySelector(".js-ec-city"),ec_cart=document.querySelector(".js-ec-cart"),itemName=[" товар"," товара"," товаров"],evoCart,ecHelpers;ecHelpers={ajax:function(e,t,n,a,r){var c,o=new XMLHttpRequest,u="",s=[];o.open(e,t,!0),o.setRequestHeader("X-REQUESTED-WITH","XMLHttpRequest"),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onload=function(){o.status>=200&&parseInt(o.status)<400?"function"==typeof a&&a(o.responseText):"function"==typeof r?r(o.responseText):new Noty({type:"error",text:o.responseText?o.responseText:"Ошибка"}).show()},o.onerror=function(){alert("error")};for(c in n)s.push(encodeURIComponent(c)+"="+encodeURIComponent(n[c]));u=s.join("&").replace(/%20/g,"+"),o.send(u)},format:function(e,t){return cases=[2,0,1,1,1,2],t[e%100>4&&e%100<20?2:cases[e%10<5?e%10:5]]},getParents:function(e,t){void 0===t&&(t=document);for(var n=[],a=e.parentNode;a!==t;){var r=a;n.push(r),a=r.parentNode}return n.push(t),n},counter:function(e,t){var n=document.getElementById(e.dataset.key),a=n.querySelector(".js-ec-count"),r=n.querySelector(".js-ec-count-input"),c=0;return a?(c=parseInt(a.textContent)+t,a.textContent=c):r&&(c=parseInt(r.value)+t,r.value=c),c},loading:function(e){ec_cart&&(e?ec_cart.classList.add("js-ec-loading"):ec_cart.classList.remove("js-ec-loading"))}},evoCart={add:function(e){var t=[];for(var n in e.dataset){t[n]=e.dataset[n]}var a=Object.assign({},t);ecHelpers.ajax("POST","/cart_add",a,function(e){evoCart.updateCartStatus(e),new Noty({type:"success",text:"Товар добавлен в корзину"}).show()})},remove:function(e){var t=e.dataset.key;if(0===t.length)return new Noty({type:"error",text:"Ошибка передачи ключа"}).show(),!1;ecHelpers.ajax("POST","/cart_remove",{key:t},function(e){evoCart.updateCartStatus(e);var n=document.getElementById(t);n&&n.parentNode.removeChild(n),new Noty({type:"info",text:"Товар удален из корзины"}).show(),evoCart.getFullCart()})},clear:function(){ecHelpers.ajax("get","/cart_clear","",function(e){evoCart.updateCartStatus(e),new Noty({type:"info",text:"Корзина очищена"}).show(),window.isCart&&evoCart.getFullCart()})},update:function(e,t){var n=e.dataset.key;t<=0?this.remove(e):ecHelpers.ajax("post","/cart_update",{key:n,count:t},function(e){evoCart.updateCartStatus(e),evoCart.getFullCart()})},getStatus:function(){ecHelpers.ajax("GET","/cart_status",null,function(e){evoCart.updateCartStatus(e)})},getFullCart:function(){ecHelpers.loading(!0);var e={delivery:ec_delivery?ec_delivery.value:null,city:ec_city?ec_city.value:null};ecHelpers.ajax("POST","/cart_full",e,function(e){data=JSON.parse(e),document.querySelector(".js-ec-cart").innerHTML=data.cart,document.querySelectorAll(".js-ec-total").forEach(function(e){e.innerHTML=data.total}),document.querySelectorAll(".js-ec-shipping").forEach(function(e){e.innerHTML=data.shipping}),document.querySelectorAll(".js-ec-dsq").forEach(function(e){e.innerHTML=data.dsq}),document.querySelectorAll(".js-ec-itogo").forEach(function(e){e.innerHTML=data.itogo}),ecHelpers.loading(!1)},function(e){var t=document.querySelector(".js-ec-ifempty");t&&t.parentNode.removeChild(t),document.querySelector(".js-ec-container").innerHTML=e,document.querySelectorAll(".js-ec-total").forEach(function(e){e.innerHTML=""})})},updateCartStatus:function(e){var t=JSON.parse(e);t.data&&(document.querySelectorAll(".js-ec-qty").forEach(function(e){e.textContent=t.data.qty}),document.querySelectorAll(".js-ec-qty-txt").forEach(function(e){e.textContent=ecHelpers.format(t.data.qty,itemName)}))}},window.onload=evoCart.getStatus(),document.addEventListener("click",function(e){var t=e.target;t.classList.contains("js-ec-add")?evoCart.add(t):t.parentNode.classList.contains("js-ec-add")&&evoCart.add(t.parentNode)}),document.querySelectorAll(".js-ec-clear").forEach(function(e){e.addEventListener("click",function(){evoCart.clear()})}),ec_cart&&ec_cart.addEventListener("click",function(e){var t=e.target;t.classList.contains("js-ec-remove")?evoCart.remove(e.target):t.classList.contains("js-ec-increment")?(_count=ecHelpers.counter(t,1),evoCart.update(t,_count)):t.classList.contains("js-ec-decrement")&&(_count=ecHelpers.counter(t,-1),evoCart.update(t,_count))}),ec_delivery&&ec_delivery.addEventListener("change",function(e){evoCart.getFullCart()}),ec_city&&ec_city.addEventListener("change",function(e){evoCart.getFullCart()});